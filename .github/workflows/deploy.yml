name: Deploy SMW (Backend + Frontend)

on:
  push:
    branches: [ dev, main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail

            PROJECT_ROOT="${{ secrets.PROJECT_ROOT }}"
            BACKEND_DIR="${{ secrets.BACKEND_DIR }}"
            FRONTEND_DIR="${{ secrets.FRONTEND_DIR }}"
            PM2_NAME="${{ secrets.PM2_NAME }}"
            GUNICORN="${{ secrets.GUNICORN_SERVICE }}"
            PYTHON_BIN="${{ secrets.PYTHON_BIN:-/usr/bin/python3 }}"

            echo "→ Pull"
            cd "$PROJECT_ROOT"
            BRANCH="${GITHUB_REF_NAME:-${{ github.ref_name }}}"
            git fetch --all --prune
            git reset --hard "origin/${BRANCH}"

            echo "→ Backend"
            cd "$PROJECT_ROOT/$BACKEND_DIR"
            $PYTHON_BIN -m venv .venv || true
            source .venv/bin/activate
            pip install --upgrade pip wheel
            pip install -r requirements.txt
            python manage.py migrate --noinput
            python manage.py collectstatic --noinput

            echo "→ Gunicorn restart"
            systemctl restart "$GUNICORN"
            systemctl is-active --quiet "$GUNICORN" || (journalctl -u "$GUNICORN" -n 120 --no-pager; exit 1)

            echo "→ Frontend build"
            cd "$PROJECT_ROOT/$FRONTEND_DIR"
            (command -v npm >/dev/null && npm ci) || npm install
            npm run build

            echo "→ PM2 (standalone)"
            pm2 describe "$PM2_NAME" >/dev/null 2>&1 \
              && pm2 restart "$PM2_NAME" --update-env \
              || pm2 start "node .next/standalone/server.js" --name "$PM2_NAME" -- --port 3000 --hostname 127.0.0.1
            pm2 save

            echo "✓ Deploy done"
