name: Deploy SMW (main)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script_stop: true
          timeout: 30m
          command_timeout: 30m
          script: |
            set -euo pipefail

            ORIGIN_IP="${{ secrets.SERVER_HOST }}"
            FRONT_URL="https://sunnysir.com/"
            ADMIN_URL="https://sunnysir.com/api/admin/login/"

            curl_ok() { curl -fsS -H 'Accept: text/html,*/*;q=0.1' -o /dev/null "$@"; }
            retry() {
              local tries="$1"; shift
              local sleep_s="$1"; shift
              local n=1
              until "$@"; do
                if [ "$n" -ge "$tries" ]; then return 1; fi
                echo "retry $n/$tries: sleeping ${sleep_s}s" >&2
                sleep "$sleep_s"
                n=$((n+1))
                sleep_s=$(( sleep_s < 15 ? sleep_s+1 : sleep_s ))
              done
            }

            echo "→ Pull latest code (main)"
            cd /var/www/html/SMW-v1
            git config --global --add safe.directory /var/www/html/SMW-v1
            git fetch origin main
            git reset --hard origin/main

            echo "→ Backend: deps/migrate/static"
            cd Backend
            . .venv/bin/activate
            pip install -r requirements.txt
            python manage.py migrate --noinput
            python manage.py collectstatic --noinput
            deactivate

            echo "→ Restart Gunicorn + reload Nginx"
            sudo -n systemctl restart gunicorn-smw
            sudo -n systemctl reload nginx
            sudo -n systemctl is-active --quiet gunicorn-smw

            echo "→ Frontend: deps/build/PM2"
            if command -v pm2 >/dev/null 2>&1 && command -v npm >/dev/null 2>&1; then
              cd /var/www/html/SMW-v1/frontend

              echo "   - Install Node deps"
              if [ -f package-lock.json ]; then
                npm ci
              else
                npm install
              fi

              echo "   - Build Next.js (production)"
              npm run build

              echo "   - Restart PM2 smw-frontend (clean)"
              pm2 delete smw-frontend || true
              pm2 start npm --name smw-frontend -- start

              pm2 save || true
              pm2 list || true
            else
              echo "pm2 or npm not found; skipping frontend deploy (health checks will fail)" >&2
            fi

            echo "→ Local health (loopback)"
            # Only check Django admin on Gunicorn locally
            retry 30 2 curl_ok http://127.0.0.1:8001/admin/login/

            echo "→ Origin health (bypass Cloudflare, via Nginx+Next)"
            retry 30 2 curl_ok --resolve sunnysir.com:443:${ORIGIN_IP} "${FRONT_URL}"
            retry 30 2 curl_ok --resolve sunnysir.com:443:${ORIGIN_IP} "${ADMIN_URL}"

            echo "→ Edge health (via Cloudflare)"
            retry 30 2 curl_ok "${FRONT_URL}"
            retry 30 2 curl_ok "${ADMIN_URL}"

            echo "✓ Deploy complete"

      - name: Purge Cloudflare cache (everything)
        if: success()
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          set -euo pipefail
          if [ -z "${CF_API_TOKEN:-}" ] || [ -z "${CF_ZONE_ID:-}" ]; then
            echo "Cloudflare secrets not set; skipping purge."
            exit 0
          fi
          echo "→ Purging Cloudflare cache for zone ${CF_ZONE_ID}…"
          curl -fsS -X POST \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/purge_cache" \
            --data '{"purge_everything": true}'
          echo "✓ Cloudflare cache purged."

      - name: (Optional) Warm key pages
        if: success()
        run: |
          set -euo pipefail
          for url in \
            "https://sunnysir.com/" \
            "https://sunnysir.com/api/admin/login/"; do
            echo "→ warming $url"
            curl -fsS -o /dev/null "$url"
          done
          echo "✓ Warmed"
